<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Goal Investment Mapping | FinCent</title>
    <script src="../../js/common.js"></script>
    <script src="../../numberToWords.js"></script>

    <style>
        :root {
            --brand-purple-1: #5b3bd6;
            --brand-purple-2: #7b5cf2;
            --brand-purple-3: #8b6ff8;
            --accent-green: #1fc08b;
            --primary: var(--brand-purple-2);
            --primary-light: var(--brand-purple-3);
            --primary-dark: var(--brand-purple-1);
            --secondary: #0f172a;
            --success: #10b981;
            --danger: #dc2626;
            --warning: #f59e0b;
            --light: #f8fafc;
            --card: #ffffff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Inter", "Segoe UI", sans-serif;
        }

        body {
            background: var(--light);
            color: var(--secondary);
            padding: 30px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--primary);
        }

        .subtitle {
            color: #64748b;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .view-tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e2e8f0;
        }

        .tab-btn {
            padding: 12px 24px;
            border: none;
            background: none;
            color: #64748b;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .view-section {
            display: none;
        }

        .view-section.active {
            display: block;
        }

        .goals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .goal-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border-left: 4px solid var(--primary);
            transition: all 0.3s;
        }

        .goal-card:hover {
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .goal-card h3 {
            font-size: 18px;
            margin-bottom: 8px;
            color: var(--secondary);
        }

        .goal-meta {
            font-size: 13px;
            color: #64748b;
            margin-bottom: 12px;
        }

        .goal-meta span {
            display: inline-block;
            margin-right: 12px;
        }

        .progress-section {
            margin-top: 16px;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            margin-bottom: 6px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
            transition: width 0.3s;
        }

        .allocation-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #e2e8f0;
        }

        .allocation-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--secondary);
            margin-bottom: 10px;
        }

        .investment-list {
            list-style: none;
        }

        .investment-item {
            font-size: 12px;
            padding: 8px;
            background: #f8fafc;
            border-radius: 6px;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .allocation-percent {
            font-weight: 600;
            color: var(--primary);
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            opacity: 0.9;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: var(--secondary);
        }

        .btn-secondary:hover {
            background: #cbd5e1;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
            padding: 6px 12px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #94a3b8;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 32px;
            max-width: 600px;
            width: 90%;
            margin: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-header h2 {
            font-size: 20px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #64748b;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e6edf8;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .form-actions button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .form-actions .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
        }

        .form-actions .btn-secondary {
            background: #f1f5f9;
            color: var(--secondary);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: linear-gradient(135deg, var(--card) 0%, #f8fafc 100%);
            padding: 22px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border-left: 4px solid var(--primary);
        }

        .summary-card h3 {
            font-size: 13px;
            color: #64748b;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .summary-card .value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .table thead {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
        }

        .table th {
            padding: 16px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
        }

        .table td {
            padding: 16px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 14px;
        }

        .table tbody tr:hover {
            background: #f8fafc;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-not-started {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-in-progress {
            background: #fef3c7;
            color: #92400e;
        }

        .status-completed {
            background: #d1fae5;
            color: #065f46;
        }

        @media(max-width: 768px) {
            body {
                padding: 16px;
            }
            .goals-grid {
                grid-template-columns: 1fr;
            }
            .summary-grid {
                grid-template-columns: 1fr;
            }
            .view-tabs {
                flex-wrap: wrap;
            }
            .modal-content {
                width: 95%;
                padding: 20px;
            }
        }

        /* Breadcrumb Styling */
        .entity-breadcrumb { background: linear-gradient(135deg, #f0f4ff 0%, #f5f3ff 100%); border: 1px solid #e0d8f5; border-radius: 8px; padding: 12px 16px; margin-bottom: 25px; display: flex; align-items: center; gap: 12px; flex-wrap: wrap; width: 100%; box-sizing: border-box; }
        .breadcrumb-label { font-size: 13px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; }
        .breadcrumb-entity-name { font-size: 16px; font-weight: 700; color: var(--primary); }
        .breadcrumb-entity-type { background: #e9e5ff; color: #6d28d9; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
    </style>
</head>

<body>

    <!-- Entity Breadcrumb -->
    <div class="entity-breadcrumb" id="entityBreadcrumb" style="display: none;">
        <span class="breadcrumb-label">Viewing:</span>
        <span class="breadcrumb-entity-name" id="breadcrumbEntityName"></span>
        <span class="breadcrumb-entity-type" id="breadcrumbEntityType"></span>
    </div>

<div class="container">
    <h1>üéØ Goal-Investment Mapping</h1>
    <p class="subtitle">Link your investments to financial goals and track allocation progress</p>

    <div class="view-tabs">
        <button class="tab-btn active" onclick="switchView('goals-view')">By Goals</button>
        <button class="tab-btn" onclick="switchView('investments-view')">By Investments</button>
        <button class="tab-btn" onclick="switchView('summary-view')">Summary</button>
    </div>

    <!-- Goals View -->
    <div id="goals-view" class="view-section active">
        <div class="goals-grid" id="goalsGrid">
            <div class="empty-state">
                <div class="empty-state-icon">üìã</div>
                <p>No goals found. Create goals in the Goals Management module first.</p>
            </div>
        </div>
    </div>

    <!-- Investments View -->
    <div id="investments-view" class="view-section">
        <table class="table">
            <thead>
                <tr>
                    <th>Investment Name</th>
                    <th>Description</th>
                    <th>Amount (‚Çπ)</th>
                    <th>Current Value (‚Çπ)</th>
                    <th>Linked Goals</th>
                    <th>Allocation %</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="investmentsTableBody">
                <tr>
                    <td colspan="7" class="empty-state">No investments found. Create investments in the Investments Management module first.</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Summary View -->
    <div id="summary-view" class="view-section">
        <div class="summary-grid">
            <div class="summary-card">
                <h3>Total Goals</h3>
                <div class="value" id="summaryTotalGoals">0</div>
            </div>
            <div class="summary-card">
                <h3>Goals with Allocations</h3>
                <div class="value" id="summaryMappedGoals">0</div>
            </div>
            <div class="summary-card">
                <h3>Total Investments</h3>
                <div class="value" id="summaryTotalInvestments">0</div>
            </div>
            <div class="summary-card">
                <h3>Total Allocated (‚Çπ)</h3>
                <div class="value" id="summaryTotalAllocated">‚Çπ0</div>
            </div>
        </div>

        <h2 style="margin-top: 30px; margin-bottom: 20px; color: var(--primary);">Allocation Details</h2>
        <table class="table">
            <thead>
                <tr>
                    <th>Goal Name</th>
                    <th>Target (‚Çπ)</th>
                    <th>Total Allocated (‚Çπ)</th>
                    <th>Allocation %</th>
                    <th>Gap (‚Çπ)</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="allocationTableBody">
                <tr>
                    <td colspan="6" class="empty-state">No allocation data available.</td>
                </tr>
            </tbody>
        </table>
    </div>

</div>

<!-- Add Allocation Modal -->
<div class="modal" id="allocationModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Add Investment to Goal</h2>
            <button class="modal-close" onclick="closeAllocationModal()">&times;</button>
        </div>
        <form onsubmit="handleAllocationSubmit(event)">
            <div class="form-group">
                <label for="selectedInvestment">Select Investment *</label>
                <select id="selectedInvestment" required>
                    <option value="">-- Select Investment --</option>
                </select>
            </div>

            <div class="form-group">
                <label for="allocationAmount">Allocation Amount (‚Çπ) *</label>
                <input type="number" id="allocationAmount" placeholder="e.g., 50000" min="0" step="0.01" required>
            </div>

            <div class="form-group">
                <label for="allocationPercent">Allocation % (Optional)</label>
                <input type="number" id="allocationPercent" placeholder="e.g., 50" min="0" max="100" step="0.01">
            </div>

            <div class="form-group">
                <label for="allocationNotes">Notes</label>
                <textarea id="allocationNotes" placeholder="Add notes about this allocation..." style="width: 100%; padding: 12px; border: 2px solid #e6edf8; border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical; min-height: 60px;"></textarea>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn-primary">Add Allocation</button>
                <button type="button" class="btn-secondary" onclick="closeAllocationModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
    let goals = [];
    let investments = [];
    let allocations = []; // Array of {id, goalId, investmentId, amount, percent, notes}
    let currentGoalId = null;
    let currentInvestmentId = null;

    function updateBreadcrumb() {
        const selectedEntityId = localStorage.getItem('selectedEntity');
        const breadcrumb = document.getElementById('entityBreadcrumb');
        
        if (selectedEntityId && breadcrumb) {
            const entities = JSON.parse(localStorage.getItem('fincentEntities') || '[]');
            const selectedEntity = entities.find(e => e.id === selectedEntityId);
            
            if (selectedEntity) {
                const entityNameEl = document.getElementById('breadcrumbEntityName');
                const entityTypeEl = document.getElementById('breadcrumbEntityType');
                
                if (entityNameEl && entityTypeEl) {
                    entityNameEl.textContent = selectedEntity.name;
                    entityTypeEl.textContent = getEntityTypeLabel(selectedEntity.type);
                    breadcrumb.style.display = 'flex';
                }
            }
        }
    }

    function initData() {
        updateBreadcrumb();
        goals = JSON.parse(localStorage.getItem('fincentGoals') || '[]');
        investments = JSON.parse(localStorage.getItem('fincentInvestments') || '[]');
        allocations = JSON.parse(localStorage.getItem('fincentAllocations') || '[]');
        renderGoalsView();
        renderInvestmentsView();
        renderSummaryView();
    }

    function switchView(viewName) {
        // Hide all views
        document.querySelectorAll('.view-section').forEach(section => {
            section.classList.remove('active');
        });
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });

        // Show selected view
        document.getElementById(viewName).classList.add('active');
        event.target.classList.add('active');
    }

    function renderGoalsView() {
        const grid = document.getElementById('goalsGrid');
        grid.innerHTML = '';

        if (goals.length === 0) {
            grid.innerHTML = `
                <div style="grid-column: 1/-1;">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <p>No goals found. Create goals in the Goals Management module first.</p>
                    </div>
                </div>
            `;
            return;
        }

        goals.forEach((goal, goalIndex) => {
            const goalId = goal.id ? goal.id.toString() : goalIndex.toString();
            const goalAllocations = allocations.filter(a => a.goalId === goalId || a.goalId === goal.id);
            const totalAllocated = goalAllocations.reduce((sum, a) => sum + a.amount, 0);
            const allocationPercent = goal.targetAmount > 0 ? (totalAllocated / goal.targetAmount) * 100 : 0;

            const purposeLabels = {
                'holiday': 'Holiday',
                'car': 'Car',
                'home': 'Home',
                'retirement': 'Retirement',
                'child_education': 'Child Education',
                'child_marriage': 'Child Marriage'
            };

            const card = document.createElement('div');
            card.className = 'goal-card';
            card.innerHTML = `
                <h3>${goal.goalName}</h3>
                <div class="goal-meta">
                    <span>üéØ ${purposeLabels[goal.goalPurpose] || '-'}</span>
                    <span>‚è±Ô∏è ${goal.timelineYears} years</span>
                </div>

                <div class="progress-section">
                    <div class="progress-label">
                        <span>Allocation Progress</span>
                        <span>${Math.round(allocationPercent)}%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${Math.min(allocationPercent, 100)}%"></div>
                    </div>
                    <div style="font-size: 12px; color: #64748b; margin-top: 6px;">
                        ‚Çπ${totalAllocated.toLocaleString('en-IN')} / ‚Çπ${goal.targetAmount.toLocaleString('en-IN')}
                    </div>
                </div>

                ${goalAllocations.length > 0 ? `
                    <div class="allocation-section">
                        <div class="allocation-title">Linked Investments (${goalAllocations.length})</div>
                        <ul class="investment-list">
                            ${goalAllocations.map(alloc => {
                                const invId = alloc.investmentId ? alloc.investmentId.toString() : '';
                                const inv = investments.find(i => (i.id ? i.id.toString() : '') === invId);
                                return `
                                    <li class="investment-item">
                                        <span>${inv?.investmentName || 'Unknown'}</span>
                                        <div>
                                            <span class="allocation-percent">‚Çπ${alloc.amount.toLocaleString('en-IN')}</span>
                                            <button class="btn btn-danger" onclick="removeAllocation('${goalId}', '${alloc.id}')">‚úï</button>
                                        </div>
                                    </li>
                                `;
                            }).join('')}
                        </ul>
                    </div>
                ` : ''}

                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="openAllocationModal('${goalId}')">+ Add Investment</button>
                </div>
            `;
            grid.appendChild(card);
        });
    }

    function renderInvestmentsView() {
        const tbody = document.getElementById('investmentsTableBody');
        tbody.innerHTML = '';

        if (investments.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No investments found. Create investments in the Investments Management module first.</td></tr>';
            return;
        }

        investments.forEach((inv, idx) => {
            const invId = inv.id ? inv.id.toString() : idx.toString();
            const invAllocations = allocations.filter(a => (a.investmentId ? a.investmentId.toString() : '') === invId);
            const totalAllocated = invAllocations.reduce((sum, a) => sum + a.amount, 0);
            const allocationPercent = inv.currentValue > 0 ? (totalAllocated / inv.currentValue) * 100 : 0;
            const linkedGoalNames = invAllocations.map(a => {
                const goalId = a.goalId ? a.goalId.toString() : '';
                const goal = goals.find(g => (g.id ? g.id.toString() : '') === goalId);
                return goal?.goalName || 'Unknown';
            }).join(', ');

            const row = document.createElement('tr');
            row.innerHTML = `
                <td><strong>${inv.investmentName}</strong></td>
                <td>${inv.description || inv.investmentType || '-'}</td>
                <td>‚Çπ${inv.investmentAmount.toLocaleString('en-IN')}</td>
                <td>‚Çπ${inv.currentValue.toLocaleString('en-IN')}</td>
                <td>${linkedGoalNames || '-'}</td>
                <td>${Math.round(allocationPercent)}%</td>
                <td>
                    <button class="btn btn-primary" onclick="openAllocationModalForInvestment('${invId}')">Allocate</button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    function renderSummaryView() {
        const totalGoals = goals.length;
        const mappedGoals = goals.filter(g => {
            const gId = g.id ? g.id.toString() : '';
            return allocations.some(a => (a.goalId ? a.goalId.toString() : '') === gId);
        }).length;
        const totalInvestments = investments.length;
        const totalAllocated = allocations.reduce((sum, a) => sum + a.amount, 0);

        document.getElementById('summaryTotalGoals').textContent = totalGoals;
        document.getElementById('summaryMappedGoals').textContent = mappedGoals;
        document.getElementById('summaryTotalInvestments').textContent = totalInvestments;
        document.getElementById('summaryTotalAllocated').textContent = '‚Çπ' + totalAllocated.toLocaleString('en-IN');

        // Render allocation table
        const tbody = document.getElementById('allocationTableBody');
        tbody.innerHTML = '';

        if (goals.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No goals found.</td></tr>';
            return;
        }

        goals.forEach(goal => {
            const goalId = goal.id ? goal.id.toString() : '';
            const goalAllocations = allocations.filter(a => (a.goalId ? a.goalId.toString() : '') === goalId);
            const totalAllocated = goalAllocations.reduce((sum, a) => sum + a.amount, 0);
            const gap = goal.targetAmount - totalAllocated;
            const gapPercent = goal.targetAmount > 0 ? (gap / goal.targetAmount) * 100 : 0;

            let status = 'Not Started';
            let statusClass = 'status-not-started';
            if (totalAllocated > 0 && gapPercent > 0) {
                status = 'In Progress';
                statusClass = 'status-in-progress';
            } else if (totalAllocated >= goal.targetAmount) {
                status = 'Completed';
                statusClass = 'status-completed';
            }

            const row = document.createElement('tr');
            row.innerHTML = `
                <td><strong>${goal.goalName}</strong></td>
                <td>‚Çπ${goal.targetAmount.toLocaleString('en-IN')}</td>
                <td>‚Çπ${totalAllocated.toLocaleString('en-IN')}</td>
                <td>${totalAllocated > 0 ? Math.round((totalAllocated / goal.targetAmount) * 100) : 0}%</td>
                <td style="color: ${gap < 0 ? '#10b981' : '#dc2626'}">‚Çπ${Math.abs(gap).toLocaleString('en-IN')}</td>
                <td><span class="status-badge ${statusClass}">${status}</span></td>
            `;
            tbody.appendChild(row);
        });
    }

    function openAllocationModal(goalId) {
        currentGoalId = goalId;
        currentInvestmentId = null;
        document.getElementById('modalTitle').textContent = 'Add Investment to Goal';
        
        // Populate investments dropdown
        const select = document.getElementById('selectedInvestment');
        select.innerHTML = '<option value="">-- Select Investment --</option>';
        investments.forEach((inv, idx) => {
            const invId = inv.id ? inv.id.toString() : idx.toString();
            const option = document.createElement('option');
            option.value = invId;
            option.textContent = `${inv.investmentName} (‚Çπ${inv.currentValue.toLocaleString('en-IN')})`;
            select.appendChild(option);
        });

        document.getElementById('allocationAmount').value = '';
        document.getElementById('allocationPercent').value = '';
        document.getElementById('allocationNotes').value = '';
        document.getElementById('allocationModal').classList.add('active');
    }

    function openAllocationModalForInvestment(investmentId) {
        currentInvestmentId = investmentId;
        currentGoalId = null;
        document.getElementById('modalTitle').textContent = 'Allocate Investment to Goal';
        
        // Populate goals dropdown (reuse selectedInvestment field for goals)
        const select = document.getElementById('selectedInvestment');
        select.innerHTML = '<option value="">-- Select Goal --</option>';
        goals.forEach((goal, idx) => {
            const goalId = goal.id ? goal.id.toString() : idx.toString();
            const option = document.createElement('option');
            option.value = goalId;
            option.textContent = `${goal.goalName} (‚Çπ${goal.targetAmount.toLocaleString('en-IN')})`;
            select.appendChild(option);
        });

        document.getElementById('allocationAmount').value = '';
        document.getElementById('allocationPercent').value = '';
        document.getElementById('allocationNotes').value = '';
        document.getElementById('allocationModal').classList.add('active');
    }

    function closeAllocationModal() {
        document.getElementById('allocationModal').classList.remove('active');
        currentGoalId = null;
        currentInvestmentId = null;
    }

    function handleAllocationSubmit(e) {
        e.preventDefault();

        const selectedId = document.getElementById('selectedInvestment').value;
        const amount = parseFloat(document.getElementById('allocationAmount').value);
        const percent = parseFloat(document.getElementById('allocationPercent').value) || 0;
        const notes = document.getElementById('allocationNotes').value;

        if (!selectedId || !amount) {
            alert('Please select an investment/goal and enter an amount');
            return;
        }

        const allocation = {
            id: Date.now().toString(),
            goalId: currentGoalId || selectedId,
            investmentId: currentInvestmentId || selectedId,
            amount: amount,
            percent: percent,
            notes: notes,
            createdAt: new Date().toISOString()
        };

        allocations.push(allocation);
        localStorage.setItem('fincentAllocations', JSON.stringify(allocations));
        renderGoalsView();
        renderInvestmentsView();
        renderSummaryView();
        closeAllocationModal();
    }

    function removeAllocation(goalId, allocationId) {
        if (confirm('Remove this allocation?')) {
            allocations = allocations.filter(a => a.id !== allocationId);
            localStorage.setItem('fincentAllocations', JSON.stringify(allocations));
            renderGoalsView();
            renderInvestmentsView();
            renderSummaryView();
        }
    }

    document.addEventListener('DOMContentLoaded', initData);
</script>

</body>
</html>
